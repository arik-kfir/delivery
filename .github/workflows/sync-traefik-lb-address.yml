name: Sync Traefik LoadBalancer IP address

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"
  push:
    branches:
      - main
    paths:
      - .github/workflows/sync-traefik-lb-address.yml

defaults:
  run:
    shell: bash -exuo pipefail {0}

env:
  FLUXCD_VERSION: 2.0.0-rc.1
  GCP_CLI_VERSION: 426.0.0
  GCP_SERVICE_ACCOUNT: delivery@arik-kfir.iam.gserviceaccount.com
  GCP_WORKLOAD_IDENTITY_PROVIDER: projects/887552287733/locations/global/workloadIdentityPools/github-actions/providers/default

concurrency:
  group: production
  cancel-in-progress: false

jobs:
  sync:
    name: Sync "${{ matrix.cluster_name }}" cluster
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        cluster_name: [arc, main]
        cluster_location: [me-west1-a]
    steps:
      - uses: actions/checkout@v3
      - run: curl -sSL -o /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/v4.33.3/yq_linux_amd64" && chmod +x /usr/local/bin/yq
      - uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ env.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.GCP_SERVICE_ACCOUNT }}
      - uses: google-github-actions/setup-gcloud@v1
        with:
          version: ${{ env.GCP_CLI_VERSION }}
      - uses: google-github-actions/get-gke-credentials@v0
        with:
          cluster_name: ${{ matrix.cluster_name }}
          location: ${{ matrix.cluster_location }}
      - uses: fluxcd/flux2/action@main
        with:
          version: ${{ env.FLUXCD_VERSION }}
      - run: kubectl wait -n traefik --for=condition=Ready ComputeAddress/gke-ingress --timeout=5m
      - run: |-
          TRAEFIK_IP="$(kubectl get -n traefik ComputeAddress/gke-ingress -ojsonpath='{.spec.address}')"
          if kubectl get ConfigMap -n traefik traefik-dynamic-values; then
            kubectl patch configmap -n traefik traefik-dynamic-values --type=merge -p "{\"data\":{\"gke-ingress-ip-address\":\"${TRAEFIK_IP}\"}}"
          else
            kubectl create configmap -n traefik traefik-dynamic-values --from-literal=gke-ingress-ip-address="${TRAEFIK_IP}"
          fi
          flux reconcile helmrelease -n traefik traefik
      - uses: EndBug/add-and-commit@v9
        with:
          add: platform/traefik/server/traefik-values.yaml
          author_name: GitHub Actions
          author_email: <gha@kfirs.com>
          message: Sync GKE ingress IP address
